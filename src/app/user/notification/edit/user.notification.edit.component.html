<loading-spinner *ngIf="loading | async"></loading-spinner>
<ng-container *ngIf="notification | async;let notificationItem">
	<div *ngIf="!(loading | async)" style="height:100%;display:flex;flex-direction:column;overflow-x:hidden;overflow-y:auto;padding:10px 20px 10px 20px">
		<div style="flex:none;display:flex;flex-direction:row;align-items:center">
			<h4 style="flex:none">Edit Notification</h4>
			<div style="flex:1;display:flex;flex-direction:row;justify-content:flex-end">
				<back></back>
			</div>
		</div>
		<div style="flex:1">
			<!-- START OF notification DETAILS SECTION -->
			<form [formGroup]="notificationGroup" novalidate>
				<div style="display:flex;flex-direction:row;align-items:center">
					<div style="flex:1">
						<mat-form-field style="width:150px">
							<mat-select formControlName="type" #select="matSelect" (selectionChange)="changeType()">
								<!-- <mat-select-trigger>{{ select.selected?.value }}</mat-select-trigger> -->
								<mat-option *ngFor="let t of types" [value]="t">{{ t }}</mat-option>
							</mat-select>
						</mat-form-field>
					</div>
					<div style="flex:none">
						<mat-slide-toggle
							formControlName="active"
							matTooltip="Activate"
							(change)="saveChanges()">
						</mat-slide-toggle>
					</div>
				</div>
				<div>
					<mat-form-field style="width:100%">
						<input
							matInput
							#main
							placeholder="Title"
							formControlName="title"
							(change)="saveChanges()">
						<mat-error *ngIf="!notificationGroup.get('title').valid || notificationGroup.get('title').touched">
							Title is required
						</mat-error>
					</mat-form-field>
				</div>
				<!-- START OF TAGS SECTION -->
				<div style="margin-bottom:20px">
					<h5 style="padding:0px">Tags(<ng-container *ngIf="tagCount | async as t"><ng-container [ngSwitch]="t"><ng-container *ngSwitchCase="-1">0</ng-container><ng-container *ngSwitchDefault>{{ t }}</ng-container></ng-container></ng-container>)</h5>
					<ng-container *ngIf="notificationTags | async;let notificationTagItems">
						<div *ngIf="notificationTagItems.length > 0">
							<div style="display:flex;flex-direction:row;justify-content:flex-start;overflow-x:auto;margin-bottom:10px">
								<div style="flex:none;margin-right:5px" *ngFor="let notificationTag of notificationTagItems; trackBy: trackNotificationTags">
									<div [ngClass]="notificationItem.type == 'Forum' ? 'forumTag' : 'serviceTag'" style="display:flex;flex-direction:row;align-items:center;padding:3px">
										<p style="margin:0 3px 0 3px">{{ notificationTag.tag }}</p>
										<i class="material-icons" (click)="removeTag(notificationTag)" style="cursor:pointer" matTooltip="Remove tag">close</i>
									</div>
								</div>
							</div>
						</div>
					</ng-container>
					<div style="display:flex;flex-direction:row;align-items:center">
						<div style="flex:1;margin-right:20px">
							<mat-form-field style="width:100%">
								<input matInput placeholder="Type a tag" [matAutocomplete]="autoTag" [formControl]="tagSearchCtrl">
								<mat-autocomplete #autoTag="matAutocomplete" [displayWith]="autoTagDisplayFn">
									<mat-option *ngFor="let tag of matAutoCompleteTags | async" (onSelectionChange)="tagSearchSelectionChange(tag)" [value]="tag">
										<p>{{ tag.tag }}</p>
									</mat-option>
								</mat-autocomplete>
							</mat-form-field>
						</div>
						<div style="flex:none">
							<i class="material-icons" (click)="createTagSearchTag()" style="cursor:pointer" matTooltipPosition="before" matTooltip="Create Tag">add</i>
						</div>
					</div>
				</div>
				<!-- search results -->
				<loading-spinner *ngIf="searchLoading | async"></loading-spinner>
				<div *ngIf="!(searchLoading | async)" style="flex:1;display:flex;flex-direction:column">
					<ng-container *ngIf="searchResults | async;let searchResultItems">
						<ng-container *ngIf="searchResultItems.length > 0; then showsearchresults else nosearchresults"></ng-container>
						<ng-template #showsearchresults>					
							<div [ngClass]="notificationGroup.get('type').value == 'Forum' ? 'forum' : 'service'" style="flex:none;display:flex;flex-direction:column;margin-bottom:5px"
								*ngFor="let result of searchResultItems; trackBy: trackResults">
								<ng-container *ngIf="notificationGroup.get('type').value == 'Forum'; then showforumresult else showserviceresult"></ng-container>
								<ng-template #showforumresult>
									<div style="flex:none;display:flex;flex-direction:row;padding:5px 5px 5px 10px;align-items:center;flex-wrap:wrap">
										<ng-container *ngIf="result.defaultForumImage | async; then showdefaultforumimage"></ng-container>
										<ng-template #showdefaultforumimage>
											<ng-container *ngIf="result.defaultForumImage | async;let image">
												<div style="flex:none;margin-right:10px">
													<img [src]="image.url">
												</div>
											</ng-container>
										</ng-template>
										<div style="flex:1">
											<ng-container *ngIf="result.defaultRegistrant | async; then showdefaultregistrant else nodefaultregistrant"></ng-container>
											<ng-template #showdefaultregistrant>
												<p style="word-break: break-all">
													<a [routerLink]="['/user/forum/view']" [queryParams]="{ userId: result.uid, forumId: result.forumId, notificationId: notificationGroup.get('notificationId').value, notificationUserId: notificationGroup.get('uid').value }" style="color:#1B1B1B" matTooltip="{{ result.title }}">{{ result.title | noTitle | truncate: 35 }} <i *ngIf="result.description.length > 0">- {{ result.description | truncate: 80 }}</i></a>
												</p>
											</ng-template>
											<ng-template #nodefaultregistrant>
												<a [routerLink]="['/forum/detail']" [queryParams]="{ forumId: result.forumId, notificationId: notificationGroup.get('notificationId').value, notificationUserId: notificationGroup.get('uid').value }" style="word-break: break-all;color:#1B1B1B" matTooltip="{{ result.title }}">{{ result.title | truncate: 35 }} <i *ngIf="result.description.length > 0">- {{ result.description | truncate: 80 }}</i></a>
											</ng-template>
										</div>
										<div style="flex:none;display:flex;flex-direction:row;align-items:center;flex-wrap:wrap">
											<!-- other button controls -->
											<div style="flex:none;display:flex;flex-direction:row;align-items:center;margin-right:5px;flex-wrap:wrap">							
												<p style="flex:none;background-color:rgb(131, 122, 122);border-radius:2px;padding:4px;color:#FFFDD0" matTooltip="{{ result.creationDate.toDate() | date: 'MMM d, y, h:mm:ss a' }}">{{ result.creationDate.toDate() | amTimeAgo }}</p>
											</div>
											<div style="flex:none;margin-right:5px">
												<mat-icon [routerLink]="['/forum/detail']" [queryParams]="{ forumId: result.forumId, notificationId: notificationGroup.get('notificationId').value, notificationUserId: notificationGroup.get('uid').value }" style="cursor:pointer" matTooltip="View Details">description</mat-icon>
											</div>
											<ng-container *ngIf="result.defaultRegistrant | async; then showaddnewcontrols"></ng-container>
											<ng-template #showaddnewcontrols>
												<div style="flex:none;margin-right:5px">
													<mat-icon style="cursor:pointer" [routerLink]="['/user/forum/service/add']" [queryParams]='{ userId: result.uid, forumId: result.forumId }' matTooltip="Add Service">add_box</mat-icon>
												</div>
												<div style="flex:none">
													<mat-icon style="cursor:pointer" [routerLink]="['/user/forum/service/new']" [queryParams]='{ userId: result.uid, forumId: result.forumId }' matTooltip="Create Service">add_circle</mat-icon>
												</div>
											</ng-template>
										</div>
									</div>
									<ng-container *ngIf="result.forumTags | async;let forumTagItems">
										<ng-container *ngIf="forumTagItems.length > 0; then showtags"></ng-container>
										<ng-template #showtags>
											<div style="flex:none;display:flex;flex-direction:row;padding:0px 5px 5px 10px">
												<ng-container *ngFor="let forumTag of forumTagItems">
													<div style="flex:none;border:1px solid #ac2c2c;background-color:rgb(250, 155, 152);padding:3px;margin-right:5px;font-size:0.85em">
														<p style="margin:0 3px 0 3px">{{ forumTag.tag }}</p>
													</div>
												</ng-container>
											</div>
										</ng-template>
									</ng-container>
								</ng-template>
								<ng-template #showserviceresult>
									<div style="flex:none;display:flex;flex-direction:row;padding:5px 5px 5px 10px;align-items:center;flex-wrap:wrap">
										<ng-container *ngIf="result.defaultServiceImage | async; then showdefaultserviceimage"></ng-container>
										<ng-template #showdefaultserviceimage>
											<ng-container *ngIf="result.defaultServiceImage | async;let image">
												<div style="flex:none;margin-right:10px">
													<img [src]="image.url">
												</div>
											</ng-container>
										</ng-template>
										<div style="flex:1;margin-right:5px">
											<p style="word-break: break-all">
												<a [routerLink]="['/service/detail']" [queryParams]="{ serviceId: result.serviceId, notificationId: notificationGroup.get('notificationId').value, notificationUserId: notificationGroup.get('uid').value }" style="flex:none;color:#1B1B1B" matTooltip="{{ result.title }}">{{ result.title | truncate: 35 }} <i *ngIf="result.description.length > 0">- {{ result.description | truncate: 80 }}</i></a>
											</p>
										</div>
										<div style="flex:none;display:flex;flex-direction:row;align-items:center;flex-wrap:wrap">
											<!-- other button controls -->
											<div style="flex:none;margin-right:5px">
												<star-rating-control
														[rating]="result.rate"
														[showHalfStars]="true"
														[starType]="'svg'"
														[readOnly]="true">
													</star-rating-control>
											</div>
											<div style="flex:none;margin-right:5px">
												<p style="background-color:rgb(131, 122, 122);border-radius:2px;padding:4px;color:#FFFDD0" matTooltip="{{ result.creationDate.toDate() | date: 'MMM d, y, h:mm:ss a' }}">{{ result.creationDate.toDate() | amTimeAgo }}</p>
											</div>
											<div style="flex:none;margin-right:5px">
												<mat-icon [routerLink]="['/service/detail']" [queryParams]="{ serviceId: result.serviceId, notificationId: notificationGroup.get('notificationId').value, notificationUserId: notificationGroup.get('uid').value }" style="cursor:pointer" matTooltip="View Details">description</mat-icon>
											</div>
											<div style="flex:none;margin-right:5px">
												<mat-icon [routerLink]="['/service/detail']" [queryParams]="{ serviceId: result.serviceId, notificationId: notificationGroup.get('notificationId').value, notificationUserId: notificationGroup.get('uid').value }" style="cursor:pointer" matTooltip="Add Forum">add_box</mat-icon>
											</div>
											<div style="flex:none;margin-right:5px">
												<mat-icon [routerLink]="['/user/forum/new']" [queryParams]="{ userId: result.uid, serviceId: result.serviceId }" style="cursor:pointer" matTooltip="Create Forum">add_circle</mat-icon>
											</div>
										</div>
									</div>
									<ng-container *ngIf="result.serviceTags | async;let serviceTagItems">
										<ng-container *ngIf="serviceTagItems.length > 0; then showtags"></ng-container>
										<ng-template #showtags>
											<div style="flex:none;display:flex;flex-direction:row;padding:0px 5px 5px 10px">
												<ng-container *ngFor="let serviceTag of serviceTagItems">
													<div style="flex:none;background-color:rgb(188, 194, 202);border:1px solid #007FFF;padding:3px;margin-right:5px;font-size:0.85em">
														<p style="margin:0 3px 0 3px">{{ serviceTag.tag }}</p>
													</div>
												</ng-container>
											</div>
										</ng-template>
									</ng-container>
								</ng-template>
							</div>
						</ng-template>
						<ng-template #nosearchresults>
							<p style="flex:none;color:#999;font-size:90%">
								<i>No Results</i>
							</p>
						</ng-template>
					</ng-container>
				</div>
				<!-- paging -->
				<div *ngIf='prevKeys?.length || nextKey' style="flex:none;padding:5px;display:flex;flex-direction:row;justify-content:flex-end">		 
					<button style="flex:none" (click)="onPrev()" *ngIf='prevKeys?.length'>Prev</button>
					<button style="flex:none" (click)="onNext()" *ngIf='nextKey'>Next</button>
				</div>
			</form>
		</div>
	</div>
</ng-container>